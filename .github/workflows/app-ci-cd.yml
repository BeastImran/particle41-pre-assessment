# GitHub Actions workflow for Python project in app/
# - Triggers on changes to app/ directory
# - Linting with black and pypy
# - Unit tests
# - SonarQube analysis
# - Docker build and push to GitHub Container Registry

name: CI/CD Pipeline

on:
  push:
    paths:
      - 'app/**'
  pull_request:
    paths:
      - 'app/**'

jobs:
  lint:
    name: Lint with Black and PyPy
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.14]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black
      - name: Run Black
        run: black --check app/

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: 3.10
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
      - name: Run Unit Tests
        run: |
          python -m unittest discover app/

  sonarqube:
    name: SonarQube Analysis (Local)
    runs-on: ubuntu-latest
    needs: test
    services:
      sonarqube:
        image: sonarqube:lts-community
        ports:
          - 9000:9000
        options: >-
          --health-cmd="curl --fail http://localhost:9000/api/system/health | grep -q '"status":"UP"'" \
          --health-interval=10s --health-timeout=5s --health-retries=10
    steps:
      - uses: actions/checkout@v4
      - name: Wait for SonarQube to be healthy
        run: |
          for i in {1..30}; do
            status=$(curl -s http://localhost:9000/api/system/health | grep -o '"status":"[A-Z]*"')
            if [[ "$status" == '"status":"UP"' ]]; then
              echo "SonarQube is UP!"
              break
            fi
            echo "Waiting for SonarQube... ($i)"
            sleep 10
          done
      - name: Generate SonarQube Token
        run: |
          curl -u admin:admin -X POST "http://localhost:9000/api/user_tokens/generate?name=gha-token" > token.json
          export SONAR_TOKEN=$(cat token.json | grep -o '"token":"[^"]*"' | cut -d':' -f2 | tr -d '"')
          echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
      - name: Install SonarScanner
        run: |
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner-cli-5.0.1.3006-linux.zip
          mv sonar-scanner-5.0.1.3006-linux sonar-scanner
      - name: Run SonarQube Scan
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        run: |
          ./sonar-scanner/bin/sonar-scanner \
            -Dsonar.projectKey=app \
            -Dsonar.sources=app \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.login=$SONAR_TOKEN

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: sonarqube
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Docker image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/app:latest ./app
      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ github.repository }}/app:latest
